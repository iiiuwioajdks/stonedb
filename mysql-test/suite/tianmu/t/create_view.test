--source include/have_tianmu.inc

#
# Test CREATE VIEW
#

--disable_warnings
DROP DATABASE IF EXISTS create_view_test;
--enable_warnings

CREATE DATABASE create_view_test;
USE create_view_test;

CREATE TABLE t1(id INT);
CREATE VIEW v1 AS SELECT * FROM t1 WHERE id>10;
INSERT INTO t1 VALUES (5), (8), (10), (20), (30);
SELECT * FROM t1;
SELECT * FROM v1;
--error 1146
SELECT * FROM v2;

CREATE VIEW v2 AS SELECT * FROM t1 WHERE id>11;
SELECT VIEW_DEFINITION FROM INFORMATION_SCHEMA.VIEWS WHERE TABLE_NAME='v1' AND TABLE_SCHEMA='create_view_test';

--error 1050
CREATE VIEW v1 AS SELECT * FROM t1 WHERE id>12;
SELECT VIEW_DEFINITION FROM INFORMATION_SCHEMA.VIEWS WHERE TABLE_NAME='v1' AND TABLE_SCHEMA='create_view_test';

CREATE OR REPLACE VIEW v1 AS SELECT * FROM t1 WHERE id>13;
SELECT VIEW_DEFINITION FROM INFORMATION_SCHEMA.VIEWS WHERE TABLE_NAME='v1' AND TABLE_SCHEMA='create_view_test';

CREATE OR REPLACE VIEW v1 AS SELECT * FROM t1 WHERE id>40;
SELECT VIEW_DEFINITION FROM INFORMATION_SCHEMA.VIEWS WHERE TABLE_NAME='v1' AND TABLE_SCHEMA='create_view_test';

INSERT INTO t1 VALUES (50), (80), (3), (2), (40);
SELECT * FROM t1;
SELECT * FROM v1;

--error 1051
DROP TABLE v1;

DROP VIEW v1;
DROP VIEW v2;
DROP TABLE t1;

--error 1146
SELECT * FROM v1;

CREATE TABLE t3 (a int, b int);
INSERT INTO t3 values
(5,10),
(10,15),
(15,20),
(20,25);

CREATE OR REPLACE VIEW v3 AS
	SELECT * FROM t3;

CREATE OR REPLACE VIEW v3 AS
	SELECT * FROM t3 WHERE a > 10;

SELECT * FROM v3;

CREATE OR REPLACE VIEW v3 AS
	SELECT a, b FROM t3 WHERE a > 5 ORDER BY b DESC;

SELECT * FROM v3;

CREATE OR REPLACE VIEW v3 AS
	SELECT a FROM t3 WHERE a <> 20;

--error 1064
CREATE OR REPLACE VIEW v3 AS
	SELECT 1, * FROM t3;

--error 1064
CREATE OR REPLACE VIEW v3 AS
	SELECT a, b::numeric FROM t3;

CREATE OR REPLACE VIEW v3 AS
	SELECT a, b, 0 AS c FROM t3;

DROP VIEW v3;
DROP TABLE t3;

# Clean UP
DROP DATABASE create_view_test;
